from PIL import Image
import numpy as np
import yaml
from datetime import datetime

IMAGE_PATH = "images/example_bitmap.png"
FILENAME = "object_groups_bitmap"+".yaml"
RESOLUTION = 8, 8  # pixels
MAZE_SIZE = 1, 1   # meters
BOX_SIZE = MAZE_SIZE[0]/RESOLUTION[0], MAZE_SIZE[1]/RESOLUTION[1]

if __name__ == '__main__':

    im = Image.open(IMAGE_PATH)
    p = np.array(im)

    im_resized = im.resize(RESOLUTION, Image.ANTIALIAS)
    p = np.array(im_resized)
    print(p.shape)
    print(p)

    idx_solid = np.where(p[:, :, 3] > 127)
    p[idx_solid] = [0, 0, 0, 255]
    idx_transparent = np.where((p[:, :, 3] <= 127))
    p[idx_transparent] = [255, 255, 255, 255]

    # im_filtered = Image.fromarray(p)

    filepath = '/home/hypatia/.ros/'+FILENAME
    file_obj = open(filepath, 'w')
    file_obj.truncate(0)  # delete all content
    file_obj.write('scene_autogenerated_on: ' + datetime.now().strftime('%m/%d/%Y, %H:%M:%S'))
    file_obj.close()

    box_element = {'box_1x1': {'color': [0.7, 0.7, 0.7, 1], 'box': [BOX_SIZE[0], BOX_SIZE[1], 0.1], 'offset': [0.0, 0.0, 0.05]}}

    with open(filepath, 'r') as yamlfile:
        current_yaml = yaml.safe_load(yamlfile)  # Note the safe_load
        current_yaml.update({'object_geometries': box_element})

    if current_yaml:
        with open(filepath, 'w') as yamlfile:
            yaml.safe_dump(current_yaml, yamlfile)  # Note the safe_dump

    boxes = []
    for id_row, id_col in zip(idx_solid[0], idx_solid[1]):
        x = (0.5 + id_col) * BOX_SIZE[0]
        y = MAZE_SIZE[1] - (0.5 + id_row) * BOX_SIZE[1]
        box_i = {'type': "box_1x1", 'frame': "world", 'position': [float(x), float(y), 0.0], 'quaternion': [0, 0, 0, 1]}
        boxes.append(box_i)

    print(idx_solid[0])
    print(idx_solid[1])

    with open(filepath, 'r') as yamlfile:
        current_yaml = yaml.safe_load(yamlfile)  # Note the safe_load
        new_box = {'maze': boxes}
        current_yaml.update(new_box)

    if current_yaml:
        with open(filepath, 'w') as yamlfile:
            yaml.safe_dump(current_yaml, yamlfile)  # Note the safe_dump